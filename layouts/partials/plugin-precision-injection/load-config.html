{{- /* 
  Insert the plugin version and build time.
  */ -}}
{{- $time := (time (sub now.Unix 28800)).Format "Jan 2 at 15:04" -}}
{{ printf "\n<!-- Precision Injection v4.0.0 (built on %s) -->" $time | safeHTML }}

{{- /* 
  Fetch the config file.
  */ -}}
  
{{- $Config := site.Data.plugin_precision_injection_config -}}
{{- $Config  = $Config | default site.Data.plugin_precision_injection.config -}}
{{- $Config  = $Config | default dict -}}

{{- /* 
  Retrieve the parameter values from the config file.
  */ -}}
  
{{- $HTMLComments := $Config.HTMLComments | default true -}}
{{- $DebugPrint := $Config.DebugPrint | default false -}}
{{- $Locations := $Config.Locations | default dict -}}
{{- $Filters := $Config.Filters | default dict -}}

{{- /* 
  Generate a slice of plugin HTML includes that have an assigned location
  */ -}}
  
{{- $Assigned := slice -}}
{{- range $location, $list := $Locations -}}
{{- $Assigned = $Assigned | append $list -}}
{{- end -}}
  
{{- /* 
  Reconstruct the Config map
  */ -}}
{{- $Config = dict "HTMLComments" $HTMLComments "Locations" $Locations "Filters" $Filters "Assigned" $Assigned -}}

{{- /* 
  Insert the Parameters map into the page scratch. 
  */ -}}
{{- .Scratch.Set "plugin-precision-injection" $Config -}}

{{- /* 
  Dump the map fetched from the page scratch into an HTML comment 
  if so flagged. 
  */ -}}
{{- if $DebugPrint -}}
{{- $config := .Scratch.Get "plugin-precision-injection" | jsonify -}}
{{- printf "\n<!--plugin-precision-injection: Config\n%s\n-->" $config | safeHTML -}}
{{- end -}}